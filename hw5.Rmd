---
title: "qz2493_datasci_hw5"
author: "Qingyue Zhuo qz2493"
date: "2022-11-13"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(ggplot2)
```

### Problem 2
#### Import Data
```{r}
urlfile = "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"
homi = read_csv(url(urlfile))
```
The raw data contains `r nrow(homi)` observations of `r ncol(homi)` variables, the names of the variable are `r names(homi)`.

#### Create a New Variable
```{r}
homi = homi %>%
  mutate(city_state = paste(city,state,sep = ","))
```

#### Summary within Cities
```{r}
homi_table = 
  homi %>%
  group_by(city_state, disposition) %>% 
  summarize(n = n()) %>%
  pivot_wider(names_from = disposition, values_from = n) %>%
  select(-"Closed by arrest") %>%
  rename(
    "Total Number of Homicides" = "Open/No arrest",
    "Number of Unsolved Homicides" = "Closed without arrest"
    ) %>%
  drop_na()
  
knitr::kable(homi_table) #How to deal with NAs
```

#### Estimation of the Proportion of Homicides Unsolved
```{r}
prop_baltimore = prop.test(x = 152, n = 1673)

esti_and_CI_baltimore = 
  broom::tidy(prop_baltimore) %>%
  select(1,5,6) %>%
  mutate(
    CI = paste(round(conf.low,3), round(conf.high, 3), sep = ","),
    CI = paste("[", CI, "]"),
    estimate = round(estimate, 3)) %>%
  select(estimate, CI) 

esti_and_CI_baltimore 
```
The estimated proportion is `r esti_and_CI_baltimore[[1]]`, the 95% confidence interval is `r esti_and_CI_baltimore[[2]]`.

#### Iterate over Cities
  - define a function to generate estimated proportion and CI for each city
```{r}
esti_and_CI = function(x,n){
  prop_test_result = prop.test(x,n)
  broom::tidy(prop_test_result) %>%
    select(1,5,6) %>%
    mutate(
    CI = paste(round(conf.low,3), round(conf.high, 3), sep = ","),
    CI = paste("[", CI, "]"),
    estimate = round(estimate, 3)) %>%
  select(estimate, CI)
}
```

  - build a tibble to store the result
```{r}
homi_df = 
  tibble(
    name = homi_table$city_state,
    samp1 = as.list(homi_table$`Number of Unsolved Homicides`),
    samp2 = as.list(homi_table$`Total Number of Homicides`),
    esti_p = map2(.x = samp1, .y = samp2, ~esti_and_CI(x = .x, n = .y)[[1]]),
    conf_int = map2(.x = samp1, .y = samp2, ~esti_and_CI(x = .x, n = .y)[[2]])
    ) %>%
  select(name, esti_p, conf_int)
homi_df
unnest(homi_df)
```

  - plot
```{r}
#define a new function to separate the upper and lower limit of CIs
esti_and_CI_plot = function(x,n){
  prop_test_result = prop.test(x,n)
  broom::tidy(prop_test_result) %>%
    select(1,5,6) %>%
    mutate(
    conf.low = round(conf.low,3),
    conf.high = round(conf.high,3),
    estimate = round(estimate, 3)) %>%
  select(estimate, conf.low, conf.high)}

#store the estimated_portion, upper and lower limit in a new tibble
homi_df_plot = 
  tibble(
    name = homi_table$city_state,
    samp1 = as.list(homi_table$`Number of Unsolved Homicides`),
    samp2 = as.list(homi_table$`Total Number of Homicides`),
    esti_p = map2(.x = samp1, .y = samp2, ~esti_and_CI_plot(x = .x, n = .y)[[1]]),
    conf_low = map2(.x = samp1, .y = samp2, ~esti_and_CI_plot(x = .x, n = .y)[[2]]),
    conf_high = map2(.x = samp1, .y = samp2, ~esti_and_CI_plot(x = .x, n = .y)[[3]])
    ) %>%
  select(name, esti_p, conf_low, conf_high)
```

```{r}
# generate the plot
ggplot(unnest(homi_df_plot), aes(x = reorder(name,esti_p), y = esti_p)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
  geom_errorbar(aes(ymin = conf_low, ymax = conf_high))
```

### Problem 3
#### Set design elements
```{r}
sim_muhat_pval = function(samp_size = 30, mu, sigma = 5) {
  
  sim_data = tibble(
    x = rnorm(n = samp_size, mean = mu, sd = sigma),
    )
  
  sim_data %>% 
    t.test(conf.level = 0.95) %>%
    broom::tidy() %>%
    select(1,3)}
```

```{r}
sim_results_df = 
  expand_grid(
    mean_null = 0,
    iter = 1:1000
  ) %>% 
  mutate(
    estimate_df = map(.x = mean_null, ~sim_muhat_pval(mu = .x))
  ) %>% 
  unnest(estimate_df)

sim_results_df
```

```{r}
sim_results_df2 = 
  expand_grid(
    mean_null = c(1,2,3,4,5,6),
    iter = 1:1000
  ) %>% 
  mutate(
    estimate_df = map(.x = mean_null, ~sim_muhat_pval(mu = .x))
  ) %>% 
  unnest(estimate_df)
sim_results_df2
```

```{r}
prop= function(mean_input) {
  sim_data = 
    sim_results_df2 %>%
    filter(mean_null == mean_input)
  length(sim_data$p.value[sim_data$p.value < 0.05])/1000
}

plot1 = 
  unnest(tibble( mean_input = c(1,2,3,4,5,6), prop = map(c(1,2,3,4,5,6), prop))) %>%
  ggplot(aes(x = mean_input, y = prop)) + geom_point()

plot1
```

```{r}

ggplot(sim_results_df2, aes(x = mean_null, y = estimate)) +
  geom_point()
```

